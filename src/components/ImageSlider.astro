---
import Picture from "./Picture.astro";

interface Props {
  images: Array<{
    src: string | ImageMetadata;
    alt?: string;
  }>;
}

const { images } = Astro.props;
const sliderId = `slider-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="image-slider not-prose" id={sliderId}>
  <!-- Frame Container -->
  <div class="bg-gray-800 dark:bg-zinc-800 rounded-2xl p-6">
    <!-- Slides Container with Side Arrows -->
    <div class="relative flex items-center">
      <!-- Left Arrow -->
      <button class="prev-btn absolute left-4 z-10 w-12 h-12 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center transition-colors">
        <span class="text-white text-2xl font-bold">‹</span>
      </button>

      <!-- Slides -->
      <div class="relative overflow-hidden rounded-lg flex-1">
        <div class="slides-wrapper flex transition-transform duration-500 ease-out">
          {images.map((image, index) => (
            <div class="slide min-w-full flex justify-center" data-slide={index}>
              <div class="w-full">
                <Picture src={image.src} alt={image.alt || `Slide ${index + 1}`} />
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Right Arrow -->
      <button class="next-btn absolute right-4 z-10 w-12 h-12 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center transition-colors">
        <span class="text-white text-2xl font-bold">›</span>
      </button>
    </div>
  </div>

  <!-- Thumbnail Navigation (moved below frame) -->
  <div class="flex justify-center gap-3" style="margin-top: 1rem;">
    {images.map((_, index) => (
      <button
        class={`thumbnail-btn w-4 h-4 rounded-full transition-all duration-300 ${index === 0 ? 'bg-gradient-to-r from-[#00d4ff] to-[#ff3366] scale-125' : 'bg-gray-300 dark:bg-gray-600 hover:bg-gray-400'}`}
        data-index={index}
      />
    ))}
  </div>
</div>

<script define:vars={{ sliderId }}>
  document.addEventListener('DOMContentLoaded', () => {
    const slider = document.getElementById(sliderId);
    if (!slider) return;

    const wrapper = slider.querySelector('.slides-wrapper');
    const thumbnails = slider.querySelectorAll('.thumbnail-btn');
    const prevBtn = slider.querySelector('.prev-btn');
    const nextBtn = slider.querySelector('.next-btn');
    const totalSlides = thumbnails.length;
    
    let currentIndex = 0;

    function goToSlide(index) {
      if (index < 0) index = totalSlides - 1;
      if (index >= totalSlides) index = 0;
      
      currentIndex = index;
      wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
      
      // Update thumbnails
      thumbnails.forEach((btn, i) => {
        if (i === currentIndex) {
          btn.classList.remove('bg-gray-300', 'dark:bg-gray-600', 'hover:bg-gray-400');
          btn.classList.add('bg-gradient-to-r', 'from-[#00d4ff]', 'to-[#ff3366]', 'scale-125');
        } else {
          btn.classList.remove('bg-gradient-to-r', 'from-[#00d4ff]', 'to-[#ff3366]', 'scale-125');
          btn.classList.add('bg-gray-300', 'dark:bg-gray-600', 'hover:bg-gray-400');
        }
      });
    }

    thumbnails.forEach((btn, index) => {
      btn.addEventListener('click', () => goToSlide(index));
    });

    prevBtn.addEventListener('click', () => goToSlide(currentIndex - 1));
    nextBtn.addEventListener('click', () => goToSlide(currentIndex + 1));

    // Drag support
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;

    wrapper.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX;
      wrapper.style.transition = 'none';
    });

    wrapper.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const diff = e.clientX - startX;
      const slideWidth = wrapper.offsetWidth;
      currentTranslate = -currentIndex * 100 + (diff / slideWidth) * 100;
      wrapper.style.transform = `translateX(${currentTranslate}%)`;
    });

    wrapper.addEventListener('mouseup', (e) => {
      if (!isDragging) return;
      isDragging = false;
      wrapper.style.transition = 'transform 0.5s ease-out';
      
      const diff = e.clientX - startX;
      if (diff > 50) {
        goToSlide(currentIndex - 1);
      } else if (diff < -50) {
        goToSlide(currentIndex + 1);
      } else {
        goToSlide(currentIndex);
      }
    });

    wrapper.addEventListener('mouseleave', () => {
      if (isDragging) {
        isDragging = false;
        wrapper.style.transition = 'transform 0.5s ease-out';
        goToSlide(currentIndex);
      }
    });

    // Touch support
    wrapper.addEventListener('touchstart', (e) => {
      isDragging = true;
      startX = e.touches[0].clientX;
      wrapper.style.transition = 'none';
    });

    wrapper.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const diff = e.touches[0].clientX - startX;
      const slideWidth = wrapper.offsetWidth;
      currentTranslate = -currentIndex * 100 + (diff / slideWidth) * 100;
      wrapper.style.transform = `translateX(${currentTranslate}%)`;
    });

    wrapper.addEventListener('touchend', (e) => {
      if (!isDragging) return;
      isDragging = false;
      wrapper.style.transition = 'transform 0.5s ease-out';
      
      const diff = e.changedTouches[0].clientX - startX;
      if (diff > 50) {
        goToSlide(currentIndex - 1);
      } else if (diff < -50) {
        goToSlide(currentIndex + 1);
      } else {
        goToSlide(currentIndex);
      }
    });
  });
</script>

<style>
  .image-slider {
    user-select: none;
  }
  
  .slides-wrapper {
    cursor: grab;
  }
  
  .slides-wrapper:active {
    cursor: grabbing;
  }
</style>
